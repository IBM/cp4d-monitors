{"version":3,"file":"component---src-pages-monitors-cp-4-d-platform-global-connections-manual-index-mdx-49dd52b4834fbe7bc4ec.js","mappings":"2RAQaA,EAAe,GACtBC,EAAc,CAClBD,aAAAA,GAEIE,EAAYC,EAAAA,EACH,SAASC,EAAT,GAGX,IAFFC,EAEC,EAFDA,WACGC,GACF,YACD,OAAO,QAACJ,EAAD,iBAAeD,EAAiBK,EAAhC,CAAuCD,WAAYA,EAAYE,QAAQ,eAG5E,kJACA,+DACA,mBACE,cAAIC,WAAW,MAAf,oDACA,cAAIA,WAAW,MAAf,kDAAsE,aAAGA,WAAW,KAChF,KAAQ,kCAD0D,oEAAtE,uBAIF,8DACA,mBACE,cAAIA,WAAW,MAAf,yDACA,cAAIA,WAAW,MAAf,wEAEF,iEACA,oEACA,yEACA,oBAAK,gBAAMA,WAAW,OAAjB,sTAcL,uEACA,oBAAK,gBAAMA,WAAW,OAAjB,siBAYL,iEACA,oBAAK,gBAAMA,WAAW,OAAjB,wJAGL,sDACA,oBAAK,gBAAMA,WAAW,OAAjB,kHAGL,gEAAkD,sBAAYA,WAAW,KAAvB,qBAClD,uFACA,oBAAK,gBAAMA,WAAW,OAAjB,y3DAkDL,kBAAG,kBAAQA,WAAW,KAAnB,SAAH,gJACA,oBAAK,gBAAMA,WAAW,OAAjB,2sBASL,8DACA,qGACA,oBAAK,gBAAMA,WAAW,OAAjB,0SAOL,8OACA,oBAAK,gBAAMA,WAAW,OAAjB,4OAML,yDACA,oBAAK,gBAAMA,WAAW,OAAjB,qRAML,kNACA,oBAAK,gBAAMA,WAAW,OAAjB,0MAIL,sCAAwB,sBAAYA,WAAW,KAAvB,KAAxB,qDACA,oBAAK,gBAAMA,WAAW,OAAjB,qPAIL,yHACA,oBAAK,gBAAMA,WAAW,OAAjB,gFAGL,2CACA,0QACA,oBAAK,gBAAMA,WAAW,OAAjB,8KAKL,mHACA,oBAAK,gBAAMA,WAAW,OAAjB,kHAGL,kIACA,oBAAK,gBAAMA,WAAW,OAAjB,8MAIL,yCACA,sEACA,oBAAK,gBAAMA,WAAW,OAAjB,gVAOL,kFACA,2NACA,oBAAK,gBAAMA,WAAW,OAAjB,kkBAmBL,4DACA,uDACA,oBAAK,gBAAMA,WAAW,OAAjB,+CAEL,iEACA,oBAAK,gBAAMA,WAAW,OAAjB,uCAEL,iDACA,oBAAK,gBAAMA,WAAW,OAAjB,mJAcTJ,EAAWK,gBAAiB","sources":["webpack://cloud-pak-deployer-monitors/./src/pages/monitors/cp4d-platform-global-connections/manual/index.mdx"],"sourcesContent":["import * as React from 'react'\n  /* @jsx mdx */\nimport { mdx } from '@mdx-js/react';\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\n\nimport DefaultLayout from \"/root/yefei/cp4d-monitors/doc/node_modules/gatsby-theme-carbon/src/templates/Default.js\";\nexport const _frontmatter = {};\nconst layoutProps = {\n  _frontmatter\n};\nconst MDXLayout = DefaultLayout;\nexport default function MDXContent({\n  components,\n  ...props\n}) {\n  return <MDXLayout {...layoutProps} {...props} components={components} mdxType=\"MDXLayout\">\n\n\n    <p>{`This page will go through all manual steps to deploy the Platform Global Connections monitor, and in addition to delete it. `}</p>\n    <p>{`The following pre-requisites are assumed:`}</p>\n    <ul>\n      <li parentName=\"ul\">{`IBM Cloud Pak for Data is successfully deployed`}</li>\n      <li parentName=\"ul\">{`(Optional) Prometheus is configured. Refer to `}<a parentName=\"li\" {...{\n          \"href\": \"/IBM/cp4d-monitors/prometheus/\"\n        }}>{`setup OpenShift Prometheus and Cloud Pak for Data ServiceMonitor`}</a>{` for instructions`}</li>\n    </ul>\n    <p>{`This manual deployment will be based on:`}</p>\n    <ul>\n      <li parentName=\"ul\">{`Source of the Monitor is located in a Git Repository`}</li>\n      <li parentName=\"ul\">{`The Image will be pushed to the internal OpenShift Image Registry `}</li>\n    </ul>\n    <h2>{`Deploy Monitor Global Platform Connections`}</h2>\n    <h3>{`Create Source Repository authorization secret`}</h3>\n    <p>{`Create a secret to access the Git Source repository`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`export GIT_SOURCE_TOKEN=<GIT_TOKEN>\nexport CP4D_PROJECT=<CP4D_PROJECT>\n\ncat << EOF | oc apply -f -\napiVersion: v1\nstringData:\n  password: \\${GIT_SOURCE_TOKEN}\nkind: Secret\nmetadata:\n  name: global-platform-connections-repo-auth\n  namespace: \\${CP4D_PROJECT}\ntype: kubernetes.io/basic-auth\nEOF\n`}</code></pre>\n    <h3>{`Build the Monitor Image and push to the registry`}</h3>\n    <pre><code parentName=\"pre\" {...{}}>{`export CP4D_PROJECT=<CP4D_PROJECT>\nexport OPENSHIFT_IMAGE_REGISTRY=image-registry.openshift-image-registry.svc:5000/\\${CP4D_PROJECT}\nexport GIT_SOURCE_TOKEN=<GIT_TOKEN>\n\noc new-build https://iamapikey:\\${GIT_SOURCE_TOKEN}@github.com/IBM/cp4d-monitors \\\\\n --context-dir cp4d-platform-global-connections  \\\\\n --name cp4d-platform-global-connections \\\\\n --source-secret global-platform-connections-repo-auth \\\\\n --to \\${OPENSHIFT_IMAGE_REGISTRY}/cp4d-platform-global-connections:latest \\\\\n --to-docker=true \\\\\n --namespace \\${CP4D_PROJECT}\n`}</code></pre>\n    <p>{`Wait for the build to complete successfully`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`export CP4D_PROJECT=<CP4D_PROJECT>\noc wait -n \\${CP4D_PROJECT} --for=condition=Complete build/cp4d-platform-global-connections-1  --timeout=300s\n`}</code></pre>\n    <p>{`or to monitor the build process:`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`export CP4D_PROJECT=<CP4D_PROJECT>\noc logs -n \\${CP4D_PROJECT} build/cp4d-platform-global-connections-1 -f\n`}</code></pre>\n    <p>{`Ensure the build finishes with the message `}<inlineCode parentName=\"p\">{`Push successful`}</inlineCode></p>\n    <h3>{`Create the Cloud Pak for Data zen-watchdog monitor configuration`}</h3>\n    <pre><code parentName=\"pre\" {...{}}>{`export CP4D_PROJECT=<CP4D_PROJECT>\nexport OPENSHIFT_IMAGE_REGISTRY=image-registry.openshift-image-registry.svc:5000/\\${CP4D_PROJECT}\n\ncat << EOF | oc apply -f -\nkind: ConfigMap\napiVersion: v1\nmetadata:\n  name: zen-alert-cp4d-platform-global-connections-monitor-extension\n  namespace: \\${CP4D_PROJECT}\n  labels:\n    app: zen-adv\n    icpdata_addon: 'true'\n    icpdata_addon_version: 4.3.0\n    release: zen-adv\ndata:\n  extensions: |\n    [\n      {\n        \"extension_point_id\": \"zen_alert_monitor\",\n        \"extension_name\": \"zen_alert_monitor_cp4d-platform-global-connections\",\n        \"display_name\": \"Global Platform Connections monitor\",\n        \"details\": {\n          \"name\": \"cp4d-platform-global-connections\",\n          \"image\": \"\\${OPENSHIFT_IMAGE_REGISTRY}/cp4d-platform-global-connections:latest\",\n          \"schedule\": \"*/15 * * * *\",\n          \"event_types\": [\n            {\n              \"name\": \"global_connections_count\",\n              \"simple_name\": \"Number of CP4D Platform connections\",\n              \"alert_type\": \"platform\",\n              \"short_description\": \"Number of CP4D Platform connections\",\n              \"long_description\": \"Number of CP4D Platform connections: <global_connections_count>\",                \n              \"resolution\": \"none\",\n              \"reason_code_prefix\": \"80\"\n            },              \n            {\n              \"name\": \"global_connection_valid\",\n              \"simple_name\": \"Test CP4D Platform connection\",\n              \"alert_type\": \"platform\",\n              \"short_description\": \"Test CP4D Platform connection\",\n              \"long_description\": \"Test result CP4D Platform connection: <global_connection_valid>\",                \n              \"resolution\": \"Validate the connection properties\",\n              \"reason_code_prefix\": \"80\"\n            }          \n          ]\n        }\n      }\n    ]\nEOF\n`}</code></pre>\n    <p><strong parentName=\"p\">{`Note:`}</strong>{` Once the ConfigMap above is created, the zen-watcher pod will detect it. Please check the log of zen-watcher pod for details. For example:`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`\nexport CP4D_PROJECT=<CP4D_PROJECT>\nexport ZEN_WATCHER_POD=$(oc get po -l component=zen-watcher -o custom-columns=CONTAINER:.metadata.name --no-headers)\noc logs \\${ZEN_WATCHER_POD}\n\ntime=\"2022-01-05 08:30:42\" level=info msg=CleanUpStaleExtensions event=\"upgrade extensions: removing stale extensions from zen-alert-cp4d-platform-global-connections-monitor-extension to the database\"\ntime=\"2022-01-05 08:30:42\" level=info msg=processExtensionHandler event=\"processing action: create for extension\" extension_name=zen_alert_monitor_cp4d-platform-global-connections\ntime=\"2022-01-05 08:30:42\" level=info msg=watchConfigMap event=\"config zen-alert-cp4d-platform-global-connections-monitor-extension added\"\n`}</code></pre>\n    <h3>{`Wait for zen-watchdog to create cronjob`}</h3>\n    <p>{`Get the watchdog-alert-monitoring-cronjob cronjob details of Cloud Pak for Data`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`export CP4D_PROJECT=<CP4D_PROJECT>\n\noc get cronjob watchdog-alert-monitoring-cronjob -n \\${CP4D_PROJECT}\n\nNAME                                SCHEDULE       SUSPEND   ACTIVE   LAST SCHEDULE   AGE\nwatchdog-alert-monitoring-cronjob   */20 * * * *   False     0        3m46s           7d3h\n`}</code></pre>\n    <p>{`This cronjob must run in order for the Global Platform Connections cronjob to be created. Optionally the schedule can be changed to trigger its execution. The pod zen-watchdog can be monitored for any error messages:`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`\nexport CP4D_PROJECT=<CP4D_PROJECT>\nexport ZEN_WATCHDOG_POD=$(oc get po -n \\${CP4D_PROJECT} -l component=zen-watchdog -o custom-columns=CONTAINER:.metadata.name --no-headers)\n\noc logs -n \\${CP4D_PROJECT} \\${ZEN_WATCHDOG_POD} -f\n`}</code></pre>\n    <p>{`The new monitor cronjob is created:`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`export CP4D_PROJECT=<CP4D_PROJECT>\noc get cronjob -n \\${CP4D_PROJECT}\n\nNAME                                       SCHEDULE       SUSPEND   ACTIVE   LAST SCHEDULE   AGE\ncp4d-platform-global-connections-cronjob   */15 * * * *    False     0        31s             7d3h\n`}</code></pre>\n    <p>{`Most monitors require access to the Cloud Pak for Data /user-home folder to cache information. To test whether this mount point is already present on the monitor use the following command:`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`export CP4D_PROJECT=<CP4D_PROJECT>\nexport CP4D_CRONJOB=cp4d-platform-global-connections-cronjob\noc set volume -n \\${CP4D_PROJECT} cronjobs/\\${CP4D_CRONJOB} | grep \"mounted at /user-home\" | wc -l\n`}</code></pre>\n    <p>{`If the result is `}<inlineCode parentName=\"p\">{`0`}</inlineCode>{`, patch the cronjob using the following command:`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`oc patch cronjob -n \\${CP4D_PROJECT} \\${CP4D_CRONJOB} \\\\\n--type=json \\\\\n--patch '[{\"op\": \"add\",\"path\": \"/spec/jobTemplate/spec/template/spec/containers/0/volumeMounts/-\",\"value\": {\"name\": \"user-home-mount\",\"mountPath\": \"/user-home\"}}]'\n`}</code></pre>\n    <p>{`Based on the schedule the cronjob will be executed. This will create a pod, which can be monitored:`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`export CP4D_PROJECT=<CP4D_PROJECT>\noc logs -n \\${CP4D_PROJECT} <PODNAME>\n`}</code></pre>\n    <h2>{`Rebuilding the image`}</h2>\n    <p>{`When changes are applied to the monitor, restarting the Build Config will re-build and push the image to the image registry. No other changed are required. The next time the cronjob is executed, the new version of the monitor image will be used`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`export CP4D_PROJECT=<CP4D_PROJECT>\nexport CP4D_CRONJOB=cp4d-platform-global-connections-cronjob\n\noc start-build -n \\${CP4D_PROJECT} cp4d-platform-global-connections\n`}</code></pre>\n    <p>{`Monitor the build using (use -2, -3 etc, based on the created build by the previous command):`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`export CP4D_PROJECT=<CP4D_PROJECT>\noc logs -n \\${CP4D_PROJECT} build/cp4d-platform-global-connections-2 -f\n`}</code></pre>\n    <p>{`Patch the cronjob so it will Always pull the image to ensure it will fetch the latest version once triggered`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`oc patch cronjob -n \\${CP4D_PROJECT} \\${CP4D_CRONJOB} \\\\\n  --type=json \\\\\n  --patch '[{\"op\":\"replace\",\"path\":\"/spec/jobTemplate/spec/template/spec/containers/0/imagePullPolicy\",\"value\":\"Always\"}]'\n`}</code></pre>\n    <h2>{`Remove the Monitor`}</h2>\n    <p>{`Use the following commands to delete the monitor`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`export CP4D_PROJECT=<CP4D_PROJECT>\nexport CP4D_CRONJOB=cp4d-platform-global-connections-cronjob\noc delete bc -n \\${CP4D_PROJECT} cp4d-platform-global-connections\noc delete cm zen-alert-cp4d-platform-global-connections-monitor-extension\noc delete secret global-platform-connections-repo-auth\noc delete cronjob \\${CP4D_CRONJOB}\n`}</code></pre>\n    <h2>{`Reset Cloud Pak for Data metrics configuration and influxdb`}</h2>\n    <p>{`If, during development, the zen-watchdog is unable to process events because of an incorrect configuration or naming convention, using the following steps to reset the zen-watchdog and its influxdb`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`export CP4D_PROJECT=<CP4D_PROJECT>\noc project \\${CP4D_PROJECT}\n\noc exec -it zen-metastoredb-0 /bin/bash\ncp -r /certs/ /tmp/\ncd /tmp/ && chmod -R 0700 certs/\ncd /cockroach \n./cockroach sql --certs-dir=/tmp/certs/ --host=zen-metastoredb-0.zen-metastoredb\nuse zen;\ndrop table policies;\ndrop table products;\ndrop table monitors;\ndrop table monitor_events;\ndrop table event_types;\nexit\n\noc delete cronjob watchdog-alert-monitoring-cronjob watchdog-alert-monitoring-purge-cronjob zen-watchdog-cronjob diagnostics-cronjob\noc delete pod -l component=zen-watchdog\n`}</code></pre>\n    <p>{`Wait for the cronjobs to be re-created`}</p>\n    <p>{`Acquire the Password for influxdb`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`oc get secret dsx-influxdb-auth -o yaml\n`}</code></pre>\n    <p>{`Copy the base64 encoded “influxdb-password”`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`base64 -d <base64 encoded data>\n`}</code></pre>\n    <p>{`Delete the influxdb entries`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`oc exec -it dsx-influxdb-0 bash\ninflux -ssl -unsafeSsl\nauth\n<enter>admin\n\nDelete the events\n\nuse WATCHDOG;\ndrop measurement events;\n`}</code></pre>\n\n    </MDXLayout>;\n}\n;\nMDXContent.isMDXComponent = true;\n      "],"names":["_frontmatter","layoutProps","MDXLayout","DefaultLayout","MDXContent","components","props","mdxType","parentName","isMDXComponent"],"sourceRoot":""}